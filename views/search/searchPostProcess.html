
<script type="text/javascript" charset="utf-8">

var tracks = document.querySelectorAll('li.track');                                          //
var trackHREFs = document.querySelectorAll('li.track a');                                    //
var inputs = document.querySelectorAll('li.track input[type="checkbox"]');                   //get info from DOM for processing; primarily hidden nodes
var trackSetLen = tracks.length;                                                             //
var userTrackResourceIDs = [];                                                                    
var permalinks = [];                                                                         

//push ALL of users's "saves" into a temporary Array (userTrackResourceIDs)
{% if user %}//if logged in, we'll do this whole rigamaroll
	{% for userTrack in user._track.list %}//use Nunjucks to push user 'saves'
	userTrackResourceIDs.push({{userTrack.resourceID | safe}});//go thru results, and push 'saves' into this temp Array
	{% endfor %}
	$(".rightPanel form").css("display", "table-cell");
{% endif %}
                                                                                        //
for(var i = 0; i<trackSetLen; i++){//call soundCloudResolveTrack on each track          //SC.initialize({
	permalinks[i] = trackHREFs.item(i).getAttribute('href');                              //  client_id: '212b7a5080f5d7f8e831583446771a02'
	soundCloudResolveTrack(permalinks, i, userTrackResourceIDs);                          //});
}                                                                                       //
                                                                                        //// permalink to a track
/**                                                                                     //var track_url = 'https://soundcloud.com/platform/motor-city-drum-ensemble-55';
 * Communicates with SoundCloud API to                                                  //
 * get pertinent track data ('/resolve' endpoint)                                       //SC.get('/resolve', { url: track_url }, function(track) {
 *                                                                                      //  SC.get('/tracks/' + track.id + '/comments', function(comments) {
 * Populates track with that data                                                       //      console.log(track.id);
 *                                                                                      //  });
 * If user is logged, display <form/>                                                   //});
 * and if user has saved it, set 'checked' attr to iCheck                               
 *                                                                                      
 * @param {array} permalinks
 * @param {number} i
 * @param {array} userTrackResourceIDs
**/
function soundCloudResolveTrack(permalinks, i, userTrackResourceIDs) {
	var permalink = permalinks[i];//qed permalink
	var CLIENT_ID = '212b7a5080f5d7f8e831583446771a02';//SoundCloud API ID
	var URI = 'http://api.soundcloud.com/resolve.json?callback=?&url=' +permalink+ '&client_id=' +CLIENT_ID;//construct request url; 'callback' param specif. for Safari

	$.getJSON(URI, function(track) {//serialize with id • serialize with stream_url • flash DOM node for EOH • (...ready for iCheck)
		if (track.streamable){//if the track's streamable, we'll show it!

			var resourceID = track.id;
			var encodedObjHTML = '';
			tracks.item(i).style.display = 'block'; 	  //reveal to user (has to be done before storing into "data-encodedobjhtml"!)
			trackHREFs.item(i).id = 'track' +resourceID;//serialize with id!
			inputs.item(i).id = resourceID;             //serialize with id!
			inputs.item(i).dataset.id = resourceID;     //serialize with id!
			trackHREFs.item(i).setAttribute('href', track.stream_url+ '?consumer_key=' +CLIENT_ID); //serialize with stream_ur!
			encodedObjHTML = inputs.item(i).dataset.encodedobjhtml = encodeURIComponent(tracks.item(i).outerHTML.toString());//flash EOH into 'data-encodedobjhtml'... now it's ready to iCheck
			$.ajax({//now cache the encodedObjHTML for rapid retrieval
				async: false,
				type: 'POST',
				url: '/postCachedTrackObj/' +resourceID+ '/' +encodedObjHTML,
				success: function(data) {
				  $('input#' +resourceID).iCheck({//manually init each iCheck ele
				    checkboxClass: 'icheckbox_square-blue',
				    increaseArea: '300%', // optional
						aria: false
				  });
					if (userTrackResourceIDs.indexOf(resourceID) !== -1) {//if user has already 'saved' then add 'checked' class and attr appropriately
						$('a#track' +resourceID+ ' div.icheckbox_square-blue').addClass('checked');
						$('a#track' +resourceID+ ' div.icheckbox_square-blue input').prop('checked', true);
					}
				}
			});
		}
		else {//all unstreamable tracks are removed from DOM
			tracks.item(i).parentNode.removeChild(tracks.item(i));
		}
	});
}
</script>